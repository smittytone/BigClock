<!DOCTYPE html>
<html lang='en'>
<head>
    <title>Big Clock</title>
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css'>
    <link href='https://fonts.googleapis.com/css?family=Rubik | Monofett | Comfortaa' rel='stylesheet'>
    <link rel='apple-touch-icon' href='https://smittytone.github.io/images/ati-bclock.png'>
    <link rel='shortcut icon' href='https://smittytone.github.io/images/ico-bclock.ico' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <meta charset='UTF-8'>
    <style>
        .center { margin-left: auto; margin-right: auto; margin-bottom: auto; margin-top: auto; }
        body {background-color: #eeeeee;}
        p {color: #111111; font-family: Comfortaa, sans-serif}
        h2 {color: #ee1111; font-family: Monofett, sans-serif; font-size: 4em}
        h4 {color: #111111; font-family: Comfortaa, sans-serif}
        h4.showhide {cursor: pointer}
        td {color: #111111; font-family: Comfortaa, sans-serif}
        hr {border-color: #ee1111}
        .error-message {color: #111111}
        .tabborder {width: 20%%}
        .tabcontent {width: 60%%}
        .uicontent {border: 2px solid #ee1111}
        .container {padding: 20px}


        @media only screen and (max-width: 640px) {
            .tabborder {width: 5%%}
            .tabcontent {width: 90%%}
            .container {padding: 5px}
            .uicontent {border: 0px}
        }
    </style>
</head>
<body>
        <div class='container'>
            <div class='uicontent' align='center'>
                <h2 align='center'>Big Clock</h2>
                <h4 align='center' class='clock-status'><i><span>This Big Clock is online</span></i></h4>
                <table width='100%%'>
                    <tr>
                         <td class='tabborder'>&nbsp;</td>
                         <td class='tabcontent'>
                            <hr>
                            <h4 align='center'>General Settings</h4>
                            <div class='mode-checkbox' style='color:#111111;font-family:Comfortaa, sans-serif'>
                                <input type='checkbox' name='mode' id='mode' value='mode'> 24-Hour Mode (Switch off for AM/PM)
                            </div>
                            <div class='mode-checkbox' style='color:#111111;font-family:Comfortaa, sans-serif'>
                                <input type='checkbox' name='bst' id='bst' value='bst'> Apply Daylight Savings Time Automatically
                            </div>
                            <div class='seconds-checkbox' style='color:#111111;font-family:Comfortaa, sans-serif'>
                                <input type='checkbox' name='seconds' id='seconds' value='seconds'> Show Seconds Indicator
                            </div>
                            <div class='flash-checkbox' style='color:#111111;font-family:Comfortaa, sans-serif'>
                                <input type='checkbox' name='flash' id='flash' value='seconds'> Flash Seconds Indicator
                            </div>
                            <div class='slider'>
                                <p>&nbsp;<br>Clock Brightness</p>
                                <input type='range' name='brightness' id='brightness' value='15' min='1' max='15'>
                                <table width='100%%'>
                                    <tr>
                                        <td width='50%%' valign='top' align='left'><small>Low</small></td>
                                        <td width='50%%' valign='top' align='right'><small>High</small></td>
                                    </tr>
                                </table>
                                <p class='brightness-status' align='right'>Brightness: <span></span></p>
                            </div>
                            <br>
                            <div class='onoff-button' style='color:#111111;font-family:Rubik, sans-serif;weight:bold' align='center'>
                                <button type='submit' id='onoff' style='height:32px;width:200px'>Turn off Display</button>
                            </div>
                            <hr>
                            <h4 align='center'>World Time Settings</h4>
                            <div class='utc-checkbox' style='color:#111111;font-family:Comfortaa, sans-serif'>
                                <small><input type='checkbox' name='utc' id='utc' value='utc'> Show World Time</small>
                            </div>
                            <div class='utc-slider'>
                                <input type='range' name='utcs' id='utcs' value='0' min='0' max='24'>
                                <table width='100%%'><tr><td width='30%%' align='left'>-12</td><td width='40%%' align='center'>0</td><td width='30%%' align='right'>+12</td></tr></table>
                                <p class='utc-status' align='right'>&nbsp;<br>Offset from local time: <span></span> hours</p>
                            </div>
                            <hr>
                            <div class='advancedsettings'>
                                <h4 class='showhide' align='center'>Click for Advanced Settings</h4>
                                <div class='advanced' align='center'>
                                    <br>
                                    <div class='reset-button' style='color:#111111;font-family:Rubik;weight:bold, sans-serif' align='center'>
                                        <button type='submit' id='reset' style='height:28px;width:200px'>Reset Big Clock</button>
                                    </div>
                                    <br>
                                    <div class='debug-checkbox' style='font-family:Comfortaa, sans-serif'>
                                        <input type='checkbox' name='debug' id='debug' value='debug'> Debug Mode
                                    </div>
                                </div>
                            </div>
                            <hr>
                        </td>
                        <td class='tabborder'>&nbsp;</td>
                    </tr>
                </table>
                <p class='text-center'><small>Big Clock &copy; 2014-18 Tony Smith</small><br>&nbsp;<br><a href='https://github.com/smittytone/BigClock' target='_blank'><img src='https://smittytone.github.io/images/rassilonblack.png' width='32' height='32'></a></p>
            </div>
        </div>

        <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
        <script>
            $('.advanced').hide();

            // Variables
            var agenturl = '%s';
            var displayon = true;
            var stateflag = false;

            // Get initial readings
            getState(updateReadout);

            // Set UI click actions: Checkboxes
            $('#mode').click(setmode);
            $('#bst').click(setbst);
            $('#seconds').click(setcolon);
            $('#flash').click(setflash);
            $('#utc').click(setutc);
            $('#debug').click(setdebug);

            // Buttons
            $('.reset-button button').click(reset);
            $('.onoff-button button').click(setlight);

            // Slider
            var slider = document.getElementById('brightness');
            slider.addEventListener('mouseup', updateSlider);
            slider.addEventListener('touchend', updateSlider);
            $('.brightness-status span').text(slider.value);
            $('#brightness').css('background', '#eeeeee');

            // World Time Slider
            slider = document.getElementById('utcs');
            slider.addEventListener('mouseup', updateutc);
            slider.addEventListener('touchend', updateutc);
            $('.utc-status span').text(slider.value);
            $('#utcs').css('background', '#eeeeee');

            $('.showhide').click(function(){
                $('.advanced').toggle();
            });

            // Functions
            function updateSlider() {
                $('.brightness-status span').text($('#brightness').val());
                setbright();
            }

            function updateutc() {
                var u = $('#utcs').val();
                $('.utc-status span').text(u - 12);
                if (document.getElementById('utc').checked == true) {
                    setutc();
                }
            }

            function updateReadout(data) {
                var s = data.split('.');
                document.getElementById('mode').checked = (s[0] == '1') ? true : false;
                document.getElementById('bst').checked = (s[1] == '1') ? true : false;
                document.getElementById('seconds').checked = (s[3] == '1') ? true : false;
                document.getElementById('flash').checked = (s[2] == '1') ? true : false;
                document.getElementById('utc').checked = (s[5] == '1') ? true : false;
                document.getElementById('debug').checked = (s[9] == '1') ? true : false;

                var b = parseInt(s[6]);
                $('.utc-status span').text(b - 12);
                $('#utcs').val(b);

                $('.onoff-button button').text((s[7] == '1') ? 'Turn off Display' : 'Turn on Display');
                displayon = (s[7] == '1');

                b = parseInt(s[4]);
                $('.brightness-status span').text(b);
                $('#brightness').val(b);

                updateState(s[8]);

                // Auto-reload data in 120 seconds
                if (!stateflag) {
                    checkState();
                    stateflag = true;
                }
            }

            function updateState(s) {
                $('.clock-status span').text('This Big Clock is ' + ((s == '0') ? 'offline' : 'online'));
            }

            function getState(callback) {
                // Request the current data
                $.ajax({
                    url : agenturl + '/settings',
                    type: 'GET',
                    success : function(response) {
                        if (callback) {
                            callback(response);
                        }
                    },
                    error : function(xhr, textStatus, error) {
                        if (error) {
                            $('.clock-status span').text(error);
                        }
                    }
                });
            }

            function checkState() {
                $.ajax({
                    url : agenturl + '/controller/state',
                    type: 'GET',
                    success : function(response) {
                        updateState(response)
                        setTimeout(checkState, 120000);
                    },
                    error : function(xhr, textStatus, error) {
                        if (error) {
                            $('.clock-status span').text(error);
                        }
                    }
                });
            }

            function setmode() {
                var d = { 'setmode' : ((document.getElementById('mode').checked == true) ? '1' : '0') };
                sendstate(d);
            }

            function setbst() {
                var d = { 'setbst' : ((document.getElementById('bst').checked == true) ? '1' : '0') };
                sendstate(d);
            }

            function setcolon() {
                var d = { 'setcolon' : ((document.getElementById('seconds').checked == true) ? '1' : '0') };
                sendstate(d);
            }

            function setflash() {
                var d = { 'setflash' : ((document.getElementById('flash').checked == true) ? '1' : '0') };
                sendstate(d);
            }

            function setbright() {
                var d = { 'setbright' : ($('#brightness').val()) };
                sendstate(d);
            }

            function setlight() {
                displayon = !displayon;
                $('.onoff-button button').text(displayon ? 'Turn off Display' : 'Turn on Display');
                var s = (displayon ? '1' : '0');
                var d = { 'setlight' :  s };
                sendstate(d);
            }

            function setutc() {
                var d = { 'setutc' : ((document.getElementById('utc').checked == true) ? '1' : '0'), 'utcval' : $('#utcs').val() };
                sendstate(d);
            }

            function sendstate(data) {
                $.ajax({
                    url : agenturl + '/settings',
                    type: 'POST',
                    data: JSON.stringify(data),
                    success: function() {
                        getState(updateReadout);
                    },
                    error : function(xhr, textStatus, error) {
                        if (error) {
                            $('.clock-status span').text(error);
                        }
                    }
                });
            }

            function reset() {
                // Trigger a settings reset
                $.ajax({
                    url : agenturl + '/action',
                    type: 'POST',
                    data: JSON.stringify({ 'action' : 'reset' }),
                    success : function(response) {
                        getState(updateReadout);
                    }
                });
            }

            function setdebug() {
                // Tell the device to enter or leave debug mode
                $.ajax({
                    url : agenturl + '/action',
                    type: 'POST',
                    data: JSON.stringify({ 'action' : 'debug', 'value' : ((document.getElementById('debug').checked == true) ? '1' : '0') }),
                    error : function(xhr, textStatus, error) {
                        if (error) {
                            $('.clock-status span').text(error);
                        }
                    }
                });
            }

            function reboot() {
                // Trigger a device restart
                $.ajax({
                    url : agenturl + '/action',
                    type: 'POST',
                    data: JSON.stringify({ 'action' : 'reboot' }),
                    success : function(response) {
                        getState(updateReadout);
                    },
                    error : function(xhr, textStatus, error) {
                        if (error) {
                            $('.clock-status span').text(error);
                        }
                    }
                });
            }
        </script>
    </body>
</html>
